---
title: "power curve"
format: html
---


```{r}
generic_pc_fname <- list.files("data",pattern = "^generic.*\\.json$", full.names = TRUE)
generic_pc <- lapply(
    generic_pc_fname,
    \(file) {
        dat <- fromJSON(file)
        # val_names <- names(dat)
        result <- as.data.frame(dat) %>% 
            rename(
                wind_speed = powerCurveData.1,
                power_kw = powerCurveData.2,
            ) %>% 
            mutate(across(airDensity, as.numeric))
        result
    }
) %>% bind_rows() %>% 
    mutate(
        class = gsub(".* - ", "", title) %>% tolower())
last_row <- generic_pc %>%
  group_by(class) %>%
  summarise(wind_speed = max(wind_speed) + 0.5) %>%
  mutate(power_kw = 0)

generic_pc <- bind_rows(generic_pc, last_row) %>%
  arrange(class, wind_speed) %>%
  group_by(class) %>%
  fill(everything(), .direction = "down") %>%
  ungroup()
write.csv(
    generic_pc,
    gzfile("data/generic_powerCurves.csv.gz"),
    row.names = FALSE
)
```


```{r}
generic_pc %>%  
    ggplot(aes(wind_speed,power_kw, col = class))+
    geom_line()+
    labs(x = "wind speed m/s", y = "power kW", col = "turbine class")+
    scale_color_aaas()+
    theme(
        legend.position = "inside",
        legend.position.inside = c(0.85,0.7)
    )

ggsave(
    filename = "fig/generic_power_curves.eps",
    width = 6,
    height = 4,
    units = "in",
    dpi = 300
)
generic_pc %>% 
    filter(power_kw>0) %>% 
    ggplot(aes(wind_speed,power_kw, col = class))+
    geom_line()+
    labs(x = "wind speed m/s", y = "power kW", col = "turbine class")+
    scale_color_aaas()+
    theme(
        legend.position = "inside",
        legend.position.inside = c(0.85,0.7)
    )

ggsave(
    filename = "fig/generic_power_curves_uncens.eps",
    width = 6,
    height = 4,
    units = "in",
    dpi = 300
)
```


## extract wind speed from GWA
```{r}
ref_catalog_2025 <- fread(
  file.path("data/ref_catalog_wind_2025.csv.gz")
)

ref_catalog_2025 %>% 
    mutate(heightNA = is.na(height_turb)) %>% 
    group_by(tech_typ, heightNA) %>% 
    summarise(
        height = mean(height_turb, na.rm = TRUE),
        n = n()
    )

```


```{r}

wf_loc <- ref_catalog_2025 %>% 
    st_as_sf(coords = c("x_coord","y_coord"), crs = 27700) %>% 
    st_transform(crs = 4326) %>% 
    st_coordinates() 
    
wf_loc %>% 
    head()
```


```{r}
height <- 100
raster_fname <- sprintf("merged_wind-speed_%dm.tif",height)
path <- "~/Documents/GWA/"

r <- rast(
    file.path(path,raster_fname)
)
wind_values <- terra::extract(r, wf_loc)
```

## update wind farm catalog with GWA wind speed
```{r}
ref_catalog_2025 <- fread(
  file.path("data/ref_catalog_wind_2025.csv.gz")
)
heights <- c(50,100,150,200)
path <- "~/Documents/GWA/"
gwa_ws <- lapply(
    heights,
    \(h) {
        raster_fname <- sprintf("merged_wind-speed_%dm.tif",h)
        r <- rast(file.path(path,raster_fname))
        wind_values <- terra::extract(r, wf_loc)
        wind_values
    }
) %>% bind_cols() %>% 
    setNames(paste0("gwa",heights))

gwa_A <- lapply(
    heights,
    \(h) {
        raster_fname <- sprintf("merged_combined-Weibull-A_%dm.tif",h)
        r <- rast(file.path(path,raster_fname))
        wind_values <- terra::extract(r, wf_loc)
        wind_values
    }
) %>% bind_cols() %>% 
    setNames(paste0("gwa_A",heights))

gwa_k <- lapply(
    heights,
    \(h) {
        raster_fname <- sprintf("merged_combined-Weibull-k_%dm.tif",h)
        r <- rast(file.path(path,raster_fname))
        wind_values <- terra::extract(r, wf_loc)
        wind_values
    }
) %>% bind_cols() %>% 
    setNames(paste0("gwa_k",heights))

ref_catalog_2025 <- ref_catalog_2025 %>% 
    bind_cols(
        gwa_ws,
        gwa_A,
        gwa_k
    )
write.csv(
    ref_catalog_2025,
    gzfile(file.path("data/ref_catalog_wind_2025.csv.gz")),
    row.names = FALSE
)
```


## figures elexon vs GWA

```{r}
# palette for offshore/onshore
mypalette <- pal_aaas()(3)[c(1,3)]
scales::show_col(mypalette)
```
```{r}
gen_p <- ref_catalog_2025 %>% 
    mutate(
    tooltip_text = paste0(
      "Site: ", site_name,
      "<br>Wind Speed: ", round(gwa100, 2), " m/s",
      "<br>Generation: ", round(quantity / 1000, 2), " GWh",
      "<br>Capacity: ", generationCapacity, " MW",
      "<br>Type: ", tech_typ
    )) %>% 
    ggplot(
        aes(
            gwa100,
            quantity/1000, 
            col = tech_typ,
            size = generationCapacity,
            text = tooltip_text)
    )+
    geom_point(alpha = 0.5)+
    scale_color_manual(values = mypalette)+
    scale_size_continuous(name = "Capacity (MW)", guide = "legend") +
    labs(x = "GWA wind speed m/s", y = "generation GWh",
    col = "Type", size = "Capacity")+
    theme(legend.position = "bottom")

ggsave(
    gen_p,
    filename = "fig/GWAsw_generation.eps",
    width = 6,
    height = 4,
    units = "in",
    dpi = 300
)
plotly::ggplotly(gen_p, tooltip = "text")
```


```{r}
gen_p2 <- ref_catalog_2025 %>% 
    mutate(
    tooltip_text = paste0(
      "Site: ", site_name,
      "<br>Wind Speed: ", round(gwa100, 2), " m/s",
      "<br>Generation: ", round(quantity / 1000, 2), " GWh",
      "<br>Capacity: ", generationCapacity, " MW",
      "<br>Type: ", tech_typ
    )) %>% 
    ggplot(
        aes(
            generationCapacity,
            quantity/1000, 
            col = tech_typ,
            size = generationCapacity,
            text = tooltip_text)
    )+
    geom_point(alpha = 0.5)+
    scale_color_manual(values = mypalette)+
    scale_size_continuous(name = "Capacity (MW)", guide = "legend") +
    labs(x = "Capacity MW", y = "generation GWh",
    col = "Type", size = "Capacity")+
    theme(legend.position = "bottom")

ggsave(
    gen_p2,
    filename = "fig/capacity_generation.eps",
    width = 6,
    height = 4,
    units = "in",
    dpi = 300
)
plotly::ggplotly(gen_p2, tooltip = "text")
 

```


```{r}
library(dplyr)
library(plotly)
library(sf)

# --- 1. Transform coordinates to lon/lat
ref_catalog_2025_ll <- ref_catalog_2025 %>%
    mutate(
    tooltip_text = paste0(
      "Site: ", site_name,
      "<br>Wind Speed: ", round(gwa100, 2), " m/s",
      "<br>Generation: ", round(quantity / 1000, 2), " GWh",
      "<br>Capacity: ", generationCapacity, " MW",
      "<br>Type: ", tech_typ
    )
  ) %>%
  st_as_sf(coords = c("x_coord", "y_coord"), crs = 27700) %>%
  st_transform(4326) %>%
  mutate(
    lon = st_coordinates(.)[, 1],
    lat = st_coordinates(.)[, 2]
  ) %>%
  st_drop_geometry()

# --- 2. Add the highlight key
df_keyed <- highlight_key(ref_catalog_2025_ll, ~bmUnit)

# --- 3. Scatter plot (left)
gen_p <- df_keyed %>%
  plot_ly(
    x = ~gwa100,
    y = ~quantity / 1000,
    color = ~tech_typ,
    colors = mypalette,
    size = ~generationCapacity,
    text = ~tooltip_text,
    hoverinfo = "text",
    type = "scatter",
    mode = "markers"
  ) %>%
  layout(
    xaxis = list(title = "GWA wind speed (m/s)"),
    yaxis = list(title = "Generation (GWh)"),
    legend = list(orientation = "h", y = -0.2)
  )

# --- 4. Map (right)
map_p <- df_keyed %>%
  plot_ly(
    lon = ~lon,
    lat = ~lat,
    color = ~tech_typ,
    colors = mypalette,
    type = 'scattergeo',
    mode = 'markers',
    marker = list(size = 8, opacity = 0.8),
    text = ~tooltip_text,
    hoverinfo = "text"
  ) %>%
  layout(
    geo = list(
      scope = "europe",
      projection = list(type = 'mercator'),
      lataxis = list(range = c(49, 61)),   # tweak to UK lat range
      lonaxis = list(range = c(-8, 2)),    # tweak to UK lon range
      showland = TRUE,
      landcolor = toRGB("gray95")
    ),
    margin = list(l = 0, r = 0, t = 0, b = 0)
  )

# --- 5. Combine & link
library(plotly)

# assuming gen_p and map_p both work individually

combo <- subplot(gen_p, map_p, nrows = 1, widths = c(0.6, 0.4))

combo <- combo %>%
  layout(
    # left scatterplot uses the left 60 % of the page
    xaxis = list(domain = c(0, 0.6), title = "GWA wind speed (m/s)"),
    yaxis = list(domain = c(0, 1), title = "Generation (GWh)"),

    # the map (scattergeo) goes in its own domain on the right
    geo = list(
      domain = list(x = c(0.6, 1), y = c(0, 1)),  # restrict to right 40 %
      scope = "europe",
      projection = list(type = "mercator"),
      lataxis = list(range = c(49, 61)),
      lonaxis = list(range = c(-8, 4)),
      showland = TRUE,
      landcolor = toRGB("gray95"),
      showcoastlines = TRUE,
      coastlinecolor = toRGB("gray80"),
      resolution = 50
    ),

    margin = list(l = 0, r = 0, t = 30, b = 0)
  ) %>%
  highlight(
    on = "plotly_hover",
    off = "plotly_doubleclick",
    color = "rgba(228,26,28,1)",
    opacityDim = 0.6,
    persistent = FALSE,
    dynamic = TRUE
  )

combo


```


```{r}
combo <- subplot(gen_p, gen_p2) 
```
```{r}
?plot
```

## Generic power curves

### fill in data for mapping

```{r}
source("aux_funct.R")
ref_catalog_2025 <- fread(
  file.path("data/ref_catalog_wind_2025.csv.gz")
) 

ref_catalog_2025 %>% 
    mutate(heightNA = is.na(height_turb)) %>% 
    group_by(tech_typ, heightNA) %>% 
    summarise(
        height = mean(height_turb, na.rm = TRUE),
        n = n()
    ) 
# filling in turbine characteristics
ref_catalog_2025 <- ref_catalog_2025 %>% 
    # completing capacity per turbine
    mutate(capacity_turb = ifelse(is.na(capacity_turb), capacity_repd/n_turb, capacity_turb)) %>%
    # imputing mean turbine height 
    group_by(tech_typ) %>% 
    mutate(height_turb_imp = ifelse(is.na(height_turb), mean(height_turb, na.rm = T), height_turb)) %>% ungroup() %>% 
    rowwise() %>% 
    mutate(
        # find the two nearest GWA levels
        ws_ht = case_when(
        height_turb_imp <= 75  ~ interp_log_ws(height_turb_imp, 50, 100, gwa50, gwa100),
        height_turb_imp <= 125 ~ interp_log_ws(height_turb_imp, 100, 150, gwa100, gwa150),
        height_turb_imp <= 175 ~ interp_log_ws(height_turb_imp, 150, 200, gwa150, gwa200),
        TRUE                   ~ interp_log_ws(height_turb_imp, 150, 200, gwa150, gwa200) # extrapolate slightly
        )
    ) %>%
    ungroup() %>% 
    mutate(
        turb_class = case_when(
            grepl("offshore",tech_typ, ignore.case = TRUE) ~ "offshore",
            ws_ht > 9.5 ~ "iec class 1",
            ws_ht > 8 ~ "iec class 2",
            TRUE ~ "iec class 3"
        )) %>% 
    group_by(rep_id) %>% 
    mutate(
        n_bmu = n(),
        wf_cap_sum = sum(generationCapacity),
        capacity_diff = abs(capacity_repd - wf_cap_sum)/capacity_repd,
        turb_bmu = n_turb * capacity_repd / sum(capacity_repd),
        capacity_bmu = capacity_repd / n_bmu
        ) %>% 
    ungroup() %>% 
    rowwise() %>% 
    mutate(
        power_est = generic_pow_conv(ws_ht, turb_class = turb_class, turb_capacity = capacity_turb)
    ) %>% ungroup()

write.csv(
    ref_catalog_2025,
    gzfile(file.path("data/ref_catalog_wind_2025.csv.gz")),
    row.names = FALSE
)
```
### capacity checks
```{r}
ref_catalog_2025 %>% 
  arrange(desc(abs(capacity_diff))) %>% 
  view()
```
### mapping generic curves

```{r}

generic_pc <- fread("data/generic_powerCurves.csv.gz")

ref_catalog_2025 <- fread(
  file.path("data/ref_catalog_wind_2025.csv.gz")) 


```

```{r}

# ref_catalog_2025 %>% 
#     ggplot(aes(ws_ht,power_est, col = tech_typ))+
#     geom_point()+
#     scale_color_manual(values = mypalette)+
#     labs(x = "GWA wind speed m/s", y = "power output MW", col = "")


```

### converting wind speed to power

```{r}
source("aux_funct.R")
source("wind_farm_data.R")
```

```{r}
with(ref_catalog_2025,
ws_ht[1]
)
set.seed(0)
test <- with(ref_catalog_2025,
rweibull(100, shape = k_ht[1], scale = A_ht[1]) 
)
test
with(ref_catalog_2025,
generic_pow_conv(
      wind_speed = test,
      turb_class = turb_class[1],
      turb_capacity = capacity_turb[1]
    )
)
```
```{r}
# wind speed 
test <- ref_catalog_2025 %>% 
  pivot_longer( cols = gwa50:gwa200, names_to = "h", values_to = "gwa_ws") %>% 
  mutate(h = as.numeric(gsub("gwa","",h)))
test %>% 
  ggplot(aes(h, gwa_ws,col = bmUnit))+
  geom_line()+
  theme(legend.position = "none")
# A parameter
test <- ref_catalog_2025 %>% 
  pivot_longer( cols = gwa_A50:gwa_A200, names_to = "h", values_to = "gwa_A") %>% 
  mutate(h = as.numeric(gsub("gwa_A","",h)))
test %>% 
  ggplot(aes(h, gwa_A,col = bmUnit))+
  geom_line()+
  theme(legend.position = "none")

# k parameter
test <- ref_catalog_2025 %>% 
  pivot_longer( cols = gwa_k50:gwa_k200, names_to = "h", values_to = "gwa_k") %>% 
  mutate(h = as.numeric(gsub("gwa_k","",h)))
test %>% 
  ggplot(aes(h, gwa_k,col = bmUnit))+
  geom_line()+
  theme(legend.position = "none")
```
### comparing against generation

```{r}
# plot(ref_catalog_2025$gen_est0, ref_catalog_2025$quantity/1000)
data_mod <- ref_catalog_2025 %>%
  mutate(across(c(quantity, gen_est0, gen_est), ~ . / 1000))
mod0 <- lm(
  quantity ~ -1+ gen_est0, 
  data = data_mod
)

summary(mod0)

mod1 <- lm(
  quantity ~ -1+ gen_est, 
  data = data_mod
)
mod0$coefficients[1]
summary(mod1)
```

```{r}
# Model with t-distributed errors (robust regression)
# install.packages("brms")
library(brms)
mod0_t <- brm(
  formula = quantity ~ -1 + gen_est0,
  data = data_mod,
  family = student(),  # <-- Student-t likelihood
  chains = 4, cores = 10, iter = 5000
)

mod1_t <- brm(
  formula = quantity ~ -1 + gen_est,
  data = data_mod,
  family = student(),  # <-- Student-t likelihood
  chains = 4, cores = 10, iter = 5000
)
```

```{r}
summary(mod0_t)
plot(mod0_t)
summary(mod1_t)
plot(mod1_t)
```
```{r}
pow_comp <- ref_catalog_2025 %>% 
    mutate(
    power_est2 = power_mws*turb_bmu*n_hours,
    tooltip_text = paste0(
      "Site: ", site_name,
      "<br>Wind Speed: ", round(gwa100, 2), " m/s",
      "<br>Elexon: ", round(quantity / 1000, 2), " GWh",
      "<br>Generic pc: ", round(power_est2 / 1000, 2), " GWh",
      "<br>Capacity: ", generationCapacity, " MW",
      "<br>Type: ", tech_typ
    )) %>% 
    ggplot(aes(power_est2/1000, quantity/1000, col = tech_typ, text = tooltip_text))+
    geom_point()+
    # coord_fixed(ratio = 1)+
    geom_abline(intercept = 0, slope = 1, col = "black", linetype = 2)+
    geom_abline(intercept = 0, slope = fixef(mod0_t)[1], col = "darkblue", linetype = 2)+
    annotate(
      "text", 
      x = max(ref_catalog_2025$power_mws * ref_catalog_2025$turb_bmu * ref_catalog_2025$n_hours)/1000 * 0.8, 
      y = max(ref_catalog_2025$quantity)/1000 * 0.9,
      label = "y = x", color = "black", hjust = 0) +
    annotate(
      "text", 
      x = max(ref_catalog_2025$power_mws * ref_catalog_2025$turb_bmu * ref_catalog_2025$n_hours)/1000 * 0.8,
      y = max(ref_catalog_2025$quantity)/1000 * 0.8, 
      label = paste0("y = ", round(fixef(mod0_t)[1], 2), " x"), color = "darkblue", hjust = 0) +
    scale_color_manual(values = mypalette)+
    labs(x = "Generic power curve", y = "Elexon", col = "")+
    theme(legend.position = "bottom")

pow_comp

ggsave(
    filename = "fig/comparison_estimate1.eps",
    width = 6,
    height = 4,
    units = "in",
    dpi = 300
)
# ggplotly(pow_comp, tooltip = "text")
```


```{r}
pow_comp <- ref_catalog_2025 %>% 
    mutate(
    power_est2 = mean_power*turb_bmu*n_hours,
    tooltip_text = paste0(
      "Site: ", site_name,
      "<br>Wind Speed: ", round(gwa100, 2), " m/s",
      "<br>Elexon: ", round(quantity / 1000, 2), " GWh",
      "<br>Generic pc: ", round(power_est2 / 1000, 2), " GWh",
      "<br>Capacity: ", generationCapacity, " MW",
      "<br>Type: ", tech_typ
    )) %>% 
    ggplot(aes(power_est2/1000, quantity/1000, col = tech_typ, text = tooltip_text))+
    geom_point()+
    geom_abline(intercept = 0, slope = 1, col = "black", linetype = 2)+
    geom_abline(intercept = 0, slope = fixef(mod1_t)[1], col = "darkblue", linetype = 2)+
    scale_color_manual(values = mypalette)+
    labs(x = "Generic power curve", y = "Elexon", col = "")+
    theme(legend.position = "bottom")
pow_comp
ggsave(
    filename = "fig/comparison_estimate2.eps",
    width = 6,
    height = 4,
    units = "in",
    dpi = 300
)

# ggplotly(pow_comp, tooltip = "text")
```